<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Precision v5.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [calculating, setCalculating] = useState(false);
            const [targetDest, setTargetDest] = useState('');
            const [mode, setMode] = useState('');
            const [tonsInput, setTonsInput] = useState('');
            const [result, setResult] = useState(null);

            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-MthW0ItRfSSthoga_Tvd7w1_OMdDXZylZQhLjG5I0bk1cEGZjqPsFUt6I373L4oFpw156lvbvYHJ/pub?output=csv';

            useEffect(() => {
                fetch(CSV_URL)
                    .then(res => res.text())
                    .then(text => {
                        // Supporto sia per virgola che per punto e virgola
                        const delimiter = text.includes(';') ? ';' : ',';
                        const rows = text.split(/\r?\n/).filter(line => line.trim());
                        const headers = rows[0].split(delimiter).map(h => h.replace(/"/g, '').trim().toUpperCase());
                        
                        const find = (key) => headers.findIndex(h => h.includes(key));
                        const colIdx = {
                            modalita: find('MODAL'), porto: find('PORTO'), fwd: find('FORWARD'),
                            dest: find('DESTIN'), inland: find('INLAND'), terminal: find('CICLO TERMINAL'),
                            freeout: find('FREE OUT'), do: find('DELIVERY ORDER'), dogana: find('DOGANA'),
                            diritto: find('DIRITTO FISSO'), tons: find('TON'), ordine: find('ORDINE')
                        };

                        const parsed = rows.slice(1).map(row => {
                            const v = row.split(delimiter);
                            const n = (idx) => {
                                if (idx === -1 || !v[idx]) return 0;
                                // Rimuove tutto ciò che non è numero, punto o virgola
                                let val = v[idx].replace(/[^\d,.-]/g, '').replace(',', '.');
                                return parseFloat(val) || 0;
                            };
                            
                            return {
                                modalita: (v[colIdx.modalita] || '').toUpperCase(),
                                porto: (v[colIdx.porto] || '').toUpperCase(),
                                fwd: (v[colIdx.fwd] || '').toUpperCase(),
                                dest: (v[colIdx.dest] || '').toUpperCase(),
                                tons: n(colIdx.tons),
                                inland: n(colIdx.inland),
                                fixedTotal: n(colIdx.freeout) + n(colIdx.do) + n(colIdx.dogana) + n(colIdx.diritto),
                                terminal: n(colIdx.terminal)
                            };
                        }).filter(r => r.porto);
                        
                        setData(parsed);
                        setLoading(false);
                    });
            }, []);

            const calculate = async () => {
                if (!targetDest || !mode || !tonsInput) return alert("Dati incompleti");
                setCalculating(true);
                const userTons = parseFloat(tonsInput);

                try {
                    // Logica semplificata e robusta
                    const filtered = data.filter(r => r.modalita.includes(mode.toUpperCase()) && r.porto.includes("LIVORNO"));
                    
                    if (filtered.length === 0) throw new Error("Nessun dato trovato per Livorno");

                    // Prendiamo le medie degli ultimi record
                    const recent = filtered.slice(-10);
                    let sumFissi = 0, sumInlandPerKm = 0, count = 0;

                    recent.forEach(r => {
                        if (r.inland > 0) {
                            sumFissi += (r.fixedTotal + (mode === 'TRUCK' ? r.terminal : 0));
                            // Calcolo Inland: usiamo un valore standard di 1.80€/km se il dato sembra sballato
                            let kmRate = r.inland / 300; // Normalizzazione su distanza media
                            sumInlandPerKm += (kmRate > 0.5 && kmRate < 4) ? kmRate : 1.80;
                            count++;
                        }
                    });

                    const avgFissiPratica = count > 0 ? sumFissi / count : 650;
                    const avgKmRate = count > 0 ? sumInlandPerKm / count : 1.85;

                    // Risultati finali basati sui tuoi 324 KM
                    const dist = 324; 
                    const resFixed = avgFissiPratica / userTons;
                    const resInland = (avgKmRate * dist) / userTons;

                    setResult({
                        fwd: recent[0].fwd,
                        porto: "LIVORNO",
                        dist: dist,
                        fixedPart: resFixed,
                        inlandPart: resInland,
                        totalPratica: avgFissiPratica
                    });
                } catch (e) { alert(e.message); } finally { setCalculating(false); }
            };

            if (loading) return <div className="p-10 text-center font-bold">CARICAMENTO...</div>;

            return (
                <div className="max-w-md mx-auto p-4 space-y-6">
                    <div className="bg-slate-900 text-white p-6 rounded-3xl shadow-xl">
                        <h1 className="text-2xl font-black italic text-blue-400">LOGI-ANALITYCS v5</h1>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-lg space-y-4">
                        <input type="text" placeholder="Destinazione" className="w-full p-4 bg-slate-100 rounded-xl font-bold" value={targetDest} onChange={e=>setTargetDest(e.target.value)} />
                        <div className="flex gap-2">
                            <select className="w-1/2 p-4 bg-slate-100 rounded-xl font-bold" value={mode} onChange={e=>setMode(e.target.value)}>
                                <option value="">Modo</option>
                                <option value="CONTAINER">Container</option>
                                <option value="TRUCK">Truck</option>
                            </select>
                            <input type="number" placeholder="Ton" className="w-1/2 p-4 bg-slate-100 rounded-xl font-bold" value={tonsInput} onChange={e=>setTonsInput(e.target.value)} />
                        </div>
                        <button onClick={calculate} className="w-full bg-blue-600 text-white p-4 rounded-xl font-black uppercase">Calcola</button>
                    </div>

                    {result && (
                        <div className="bg-white p-6 rounded-3xl shadow-lg border-t-8 border-blue-600 space-y-4">
                            <div className="flex justify-between font-black">
                                <span>{result.porto}</span>
                                <span className="text-blue-600">{result.dist} KM</span>
                            </div>
                            <div className="text-sm space-y-2 border-b pb-4">
                                <div className="flex justify-between"><span>Oneri Fissi (ton):</span><b>€ {result.fixedPart.toFixed(2)}</b></div>
                                <div className="flex justify-between"><span>Trasporto (ton):</span><b>€ {result.inlandPart.toFixed(2)}</b></div>
                            </div>
                            <div className="bg-slate-900 text-white p-6 rounded-2xl text-center">
                                <p className="text-xs opacity-50 uppercase font-bold">Costo Totale Stimato</p>
                                <p className="text-4xl font-black italic">€ {((result.fixedPart + result.inlandPart) * tonsInput).toLocaleString('it-IT', {maximumFractionDigits: 2})}</p>
                                <p className="text-blue-400 font-bold mt-2">€ {(result.fixedPart + result.inlandPart).toFixed(2)} / TON</p>
                            </div>
                            <p className="text-[10px] text-slate-400 text-center uppercase font-bold tracking-widest">Somma Fissi Pratica stimata: € {result.totalPratica.toFixed(2)}</p>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
