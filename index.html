<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Expert - Precision v4.2</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [destinations, setDestinations] = useState([]);
            const [loading, setLoading] = useState(true);
            const [calculating, setCalculating] = useState(false);
            const [targetDest, setTargetDest] = useState('');
            const [mode, setMode] = useState('');
            const [tonsInput, setTonsInput] = useState('');
            const [result, setResult] = useState(null);

            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-MthW0ItRfSSthoga_Tvd7w1_OMdDXZylZQhLjG5I0bk1cEGZjqPsFUt6I373L4oFpw156lvbvYHJ/pub?output=csv';

            useEffect(() => {
                fetch(CSV_URL)
                    .then(res => res.text())
                    .then(text => {
                        const rows = text.split(/\r?\n/).filter(line => line.trim());
                        const headers = rows[0].split(',').map(h => h.replace(/"/g, '').trim().toUpperCase());
                        const find = (key) => headers.findIndex(h => h.includes(key));

                        const colIdx = {
                            modalita: find('MODAL'), porto: find('PORTO'), fwd: find('FORWARD'),
                            dest: find('DESTIN'), inland: find('INLAND'), terminal: find('CICLO TERMINAL'),
                            freeout: find('FREE OUT'), do: find('DELIVERY ORDER'), dogana: find('DOGANA'),
                            diritto: find('DIRITTO FISSO'), flegt: find('FLEGT'), visita: find('VISITA'),
                            soste: find('SOSTE'), svincolo: find('SVINCOLO'), tons: find('TON'),
                            ordine: find('ORDINE')
                        };

                        const parsed = rows.slice(1).map(row => {
                            const v = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || row.split(',');
                            const n = (idx) => {
                                if (idx === -1 || !v[idx]) return 0;
                                let raw = v[idx].replace(/"/g, '').replace(/[^\d,.-]/g, '').replace(',', '.');
                                return parseFloat(raw) || 0;
                            };
                            const s = (idx) => (idx !== -1 && v[idx]) ? v[idx].replace(/"/g, '').trim() : '';

                            // Somma rigorosa solo delle voci FISSE (escluso Inland)
                            const sumFissi = n(colIdx.freeout) + n(colIdx.do) + n(colIdx.dogana) + 
                                             n(colIdx.diritto) + n(colIdx.flegt) + n(colIdx.visita) + 
                                             n(colIdx.soste) + n(colIdx.svincolo);

                            return {
                                modalita: s(colIdx.modalita), porto: s(colIdx.porto), fwd: s(colIdx.fwd),
                                dest: s(colIdx.dest), tonsRecord: n(colIdx.tons),
                                inlandRecord: n(colIdx.inland), 
                                terminalRecord: n(colIdx.terminal),
                                totalFixedPratica: sumFissi,
                                ordine: s(colIdx.ordine)
                            };
                        }).filter(r => r.ordine);
                        
                        setData(parsed);
                        setDestinations([...new Set(parsed.map(r => r.dest))].sort());
                        setLoading(false);
                    });
            }, []);

            const getCoords = async (city) => {
                const db = { 'LIVORNO': {lat:43.54, lon:10.31}, 'VENEZIA': {lat:45.44, lon:12.31}, 'GENOVA': {lat:44.40, lon:8.94}, 'RAVENNA': {lat:44.41, lon:12.20}, 'LA SPEZIA': {lat:44.10, lon:9.82}, 'TRIESTE': {lat:45.64, lon:13.77} };
                if (db[city.toUpperCase()]) return db[city.toUpperCase()];
                try {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)},Italy&limit=1`);
                    const d = await r.json();
                    return d.length > 0 ? { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) } : null;
                } catch { return null; }
            };

            const getRoadDist = async (c1, c2) => {
                try {
                    const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${c1.lon},${c1.lat};${c2.lon},${c2.lat}?overview=false`);
                    const d = await r.json();
                    return d.code === 'Ok' ? d.routes[0].distance / 1000 : null;
                } catch { return null; }
            };

            const calculate = async () => {
                if (!targetDest || !mode || !tonsInput) return alert("Inserire dati");
                const userTons = parseFloat(tonsInput);
                setCalculating(true);
                try {
                    const targetCoords = await getCoords(targetDest);
                    if (!targetCoords) throw new Error("Città non trovata");

                    const filtered = data.filter(r => r.modalita.toUpperCase().includes(mode.toUpperCase()));
                    const ports = [...new Set(filtered.map(r => r.porto))];
                    
                    let portDists = [];
                    for (const p of ports) {
                        const pc = await getCoords(p);
                        if (pc) {
                            const d = await getRoadDist(pc, targetCoords);
                            if (d) portDists.push({ name: p, dist: d, coords: pc });
                        }
                    }
                    portDists.sort((a,b) => a.dist - b.dist);
                    const nearestPort = portDists[0];
                    const portOrders = filtered.filter(r => r.porto === nearestPort.name);
                    const fwds = [...new Set(portOrders.map(r => r.fwd))];

                    let options = [];
                    for (const fwd of fwds) {
                        const fwdOrders = portOrders.filter(o => o.fwd === fwd);
                        const history = fwdOrders.slice(-10);
                        
                        let totalFixedSum = 0;
                        let kmRateFullTruckSum = 0;
                        let valid = 0;

                        for (const o of history) {
                            const oc = await getCoords(o.dest);
                            if (oc) {
                                const d = await getRoadDist(nearestPort.coords, oc);
                                if (d > 10 && o.tonsRecord > 0) {
                                    // Costo fisso REALE della pratica (inclusi terminal se Truck)
                                    const practicalFissi = o.totalFixedPratica + (mode === 'TRUCK' ? o.terminalRecord : 0);
                                    totalFixedSum += practicalFissi;
                                    
                                    // Costo al KM per l'intero viaggio
                                    kmRateFullTruckSum += (o.inlandRecord / d);
                                    valid++;
                                }
                            }
                        }

                        const avgFixedPratica = valid > 0 ? totalFixedSum / valid : 700; 
                        const avgKmRateFullTruck = valid > 0 ? kmRateFullTruckSum / valid : 1.85;

                        const finalFixedPart = avgFixedPratica / userTons;
                        const finalInlandPart = (avgKmRateFullTruck * nearestPort.dist) / userTons;

                        options.push({
                            porto: nearestPort.name, fwd, 
                            fixedPart: finalFixedPart, 
                            inlandPart: finalInlandPart, 
                            unitCost: finalFixedPart + finalInlandPart,
                            dist: nearestPort.dist,
                            rawFixed: avgFixedPratica // Per il debug
                        });
                    }

                    options.sort((a,b) => a.unitCost - b.unitCost);
                    setResult(options[0]);
                } catch (e) { alert(e.message); } finally { setCalculating(false); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-blue-600 animate-pulse">CARICAMENTO...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-10 flex flex-col">
                    <header className="bg-slate-900 p-8 pt-12 rounded-b-[2.5rem] shadow-xl text-white">
                        <h1 className="text-3xl font-black italic tracking-tighter text-blue-400">LOGI-ANALITYCS</h1>
                        <p className="text-[10px] font-bold uppercase tracking-widest mt-2 opacity-60">Precision Logic v4.2</p>
                    </header>

                    <main className="px-6 -mt-8 flex-grow">
                        <div className="bg-white p-7 rounded-[2.5rem] shadow-2xl space-y-4 border border-slate-100">
                            <input type="text" list="dl" value={targetDest} onChange={e=>setTargetDest(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700" placeholder="Destinazione" />
                            <datalist id="dl">{destinations.map(d=><option key={d} value={d}/>)}</datalist>
                            <div className="grid grid-cols-2 gap-4">
                                <select value={mode} onChange={e=>setMode(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-slate-700">
                                    <option value="">Modalità</option>
                                    <option value="CONTAINER">Container</option>
                                    <option value="TRUCK">Truck</option>
                                </select>
                                <input type="number" value={tonsInput} onChange={e=>setTonsInput(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-slate-700" placeholder="Ton." />
                            </div>
                            <button onClick={calculate} disabled={calculating} className="w-full bg-blue-600 text-white p-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-all">
                                {calculating ? "CALCOLO..." : "PREVENTIVO PRECISIO"}
                            </button>
                        </div>

                        {result && (
                            <div className="mt-8 bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in fade-in slide-in-from-bottom-6">
                                <div className="flex justify-between items-center mb-6">
                                    <p className="text-2xl font-black text-slate-800 italic uppercase">{result.porto}</p>
                                    <div className="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black">{Math.round(result.dist)} KM</div>
                                </div>

                                <div className="space-y-3 mb-6">
                                    <div className="flex justify-between items-center border-b border-slate-50 pb-2">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Forwarder</span>
                                        <span className="text-sm font-black text-slate-800">{result.fwd}</span>
                                    </div>
                                    <div className="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase italic">Oneri Fissi Portuali</span>
                                        <span className="text-sm font-black text-slate-700">€ {result.fixedPart.toFixed(2)}/ton</span>
                                    </div>
                                    <div className="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase italic">Trasporto Inland</span>
                                        <span className="text-sm font-black text-slate-700">€ {result.inlandPart.toFixed(2)}/ton</span>
                                    </div>
                                </div>

                                <div className="bg-slate-900 p-6 rounded-[2rem] text-center shadow-inner mb-4">
                                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Costo Totale Stimato</p>
                                    <p className="text-5xl font-black text-white tracking-tighter">
                                        € {(result.unitCost * tonsInput).toLocaleString('it-IT', {minimumFractionDigits: 2})}
                                    </p>
                                    <p className="text-[10px] text-blue-400 font-black mt-3 uppercase tracking-widest">€ {result.unitCost.toFixed(2)} / ton</p>
                                </div>
                                
                                <div className="border-t border-dashed border-slate-200 pt-4 px-2">
                                    <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Log di Verifica Dati:</p>
                                    <p className="text-[10px] text-slate-500">Somma Fissi Pratica (Media): <b>€ {result.rawFixed.toFixed(2)}</b></p>
                                    <p className="text-[10px] text-slate-500">Ripartizione su {tonsInput} TON: <b>€ {(result.rawFixed / tonsInput).toFixed(2)}/ton</b></p>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
