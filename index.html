<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Smart Pro - Ultra-Compatible</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [destinations, setDestinations] = useState([]);
            const [loading, setLoading] = useState(true);
            const [calculating, setCalculating] = useState(false);
            
            const [targetDest, setTargetDest] = useState('');
            const [mode, setMode] = useState('');
            const [tons, setTons] = useState('');
            const [result, setResult] = useState(null);

            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-MthW0ItRfSSthoga_Tvd7w1_OMdDXZylZQhLjG5I0bk1cEGZjqPsFUt6I373L4oFpw156lvbvYHJ/pub?output=csv';

            useEffect(() => {
                fetch(CSV_URL)
                    .then(res => res.text())
                    .then(text => {
                        // Supporto per CSV con virgolette e virgole nei campi
                        const rows = text.split(/\r?\n/).filter(line => line.trim());
                        const headers = rows[0].split(',').map(h => h.replace(/"/g, '').trim().toUpperCase());
                        
                        // Mappatura flessibile delle colonne
                        const colIdx = {
                            modalita: headers.findIndex(h => h.includes('MODAL')),
                            porto: headers.findIndex(h => h.includes('PORTO')),
                            forwarder: headers.findIndex(h => h.includes('FORWARD') || h.includes('FORNITORE')),
                            destinazione: headers.findIndex(h => h.includes('DESTIN')),
                            costo: headers.findIndex(h => h.includes('€') || h.includes('TON') || h.includes('COSTO')),
                            ordine: headers.findIndex(h => h.includes('ORDINE'))
                        };

                        const parsed = rows.slice(1).map(row => {
                            // Regex per dividere CSV rispettando le virgolette (es: "1.200,50")
                            const values = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || row.split(',');
                            const clean = (val) => val ? val.replace(/"/g, '').trim() : '';
                            
                            return {
                                modalita: clean(values[colIdx.modalita]),
                                porto: clean(values[colIdx.porto]),
                                forwarder: clean(values[colIdx.forwarder]),
                                destinazione: clean(values[colIdx.destinazione]),
                                costo: clean(values[colIdx.costo]),
                                ordine: clean(values[colIdx.ordine])
                            };
                        }).filter(r => r.ordine && r.costo);
                        
                        setData(parsed);
                        setDestinations([...new Set(parsed.map(r => r.destinazione))].sort());
                        setLoading(false);
                    }).catch(e => alert("Errore caricamento dati: " + e.message));
            }, []);

            const getCoords = async (city) => {
                const db = { 'LIVORNO': {lat:43.54, lon:10.31}, 'VENEZIA': {lat:45.44, lon:12.31}, 'GENOVA': {lat:44.40, lon:8.94}, 'RAVENNA': {lat:44.41, lon:12.20}, 'LA SPEZIA': {lat:44.10, lon:9.82}, 'TRIESTE': {lat:45.64, lon:13.77} };
                const c = city.toUpperCase();
                if (db[c]) return db[c];
                try {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)},Italy&limit=1`);
                    const d = await r.json();
                    return d.length > 0 ? { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) } : null;
                } catch { return null; }
            };

            const getRoadDist = async (c1, c2) => {
                try {
                    const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${c1.lon},${c1.lat};${c2.lon},${c2.lat}?overview=false`);
                    const d = await r.json();
                    if (d.code === 'Ok') return d.routes[0].distance / 1000;
                } catch {}
                const R = 6371;
                const dLat = (c2.lat-c1.lat)*Math.PI/180;
                const dLon = (c2.lon-c1.lon)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(c1.lat*Math.PI/180)*Math.cos(c2.lat*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))) * 1.25;
            };

            const calculate = async () => {
                if (!targetDest || !mode || !tons) return alert("Compila tutti i campi");
                setCalculating(true);
                setResult(null);

                try {
                    const targetCoords = await getCoords(targetDest);
                    if (!targetCoords) throw new Error("Città non trovata");

                    // Filtro ultra-tollerante per la modalità
                    const filtered = data.filter(r => r.modalita.toUpperCase().includes(mode.toUpperCase()));
                    if (filtered.length === 0) throw new Error(`Nessun dato per '${mode}'. Verifica che la colonna modalità contenga questo termine.`);

                    const uniquePorts = [...new Set(filtered.map(r => r.porto))];
                    let portDists = [];
                    for (const p of uniquePorts) {
                        const pc = await getCoords(p);
                        if (pc) {
                            const d = await getRoadDist(pc, targetCoords);
                            portDists.push({ name: p, dist: d, coords: pc });
                        }
                    }

                    portDists.sort((a,b) => a.dist - b.dist);
                    const nearestPort = portDists[0];
                    const portOrders = filtered.filter(r => r.porto === nearestPort.name);
                    const forwarders = [...new Set(portOrders.map(r => r.forwarder))];

                    let finalOptions = [];
                    for (const fwd of forwarders) {
                        const fwdOrders = portOrders.filter(o => o.forwarder === fwd);
                        const exact = fwdOrders.filter(o => o.destinazione.toUpperCase() === targetDest.toUpperCase());
                        
                        let unitCost = 0;
                        if (exact.length > 0) {
                            let wSum = 0, cSum = 0;
                            exact.forEach((o, i) => {
                                const w = i + 1;
                                const c = parseFloat(o.costo.replace(',', '.'));
                                if(!isNaN(c)) { cSum += (c * w); wSum += w; }
                            });
                            unitCost = cSum / wSum;
                        } else {
                            let rates = [];
                            for (const o of fwdOrders.slice(-5)) {
                                const oc = await getCoords(o.destinazione);
                                if (oc) {
                                    const d = await getRoadDist(nearestPort.coords, oc);
                                    const c = parseFloat(o.costo.replace(',', '.'));
                                    if (d > 0 && !isNaN(c)) rates.push(c / d);
                                }
                            }
                            unitCost = (rates.length > 0 ? rates.reduce((a,b)=>a+b,0)/rates.length : 1.4) * nearestPort.dist;
                        }
                        finalOptions.push({ porto: nearestPort.name, fwd, unitCost, dist: nearestPort.dist, isEst: exact.length === 0 });
                    }

                    finalOptions.sort((a,b) => a.unitCost - b.unitCost);
                    setResult(finalOptions[0]);

                } catch (e) {
                    alert(e.message);
                } finally {
                    setCalculating(false);
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-blue-600 animate-pulse">CARICAMENTO DATI AZIENDALI...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-blue-800 p-8 pt-12 rounded-b-[3rem] shadow-xl text-white">
                        <h1 className="text-3xl font-black italic tracking-tighter">LOGI-PRO</h1>
                        <p className="text-blue-300 text-[10px] font-bold uppercase tracking-[0.2em] mt-1">Smart Routing Engine</p>
                    </header>

                    <main className="px-6 -mt-10 flex-grow">
                        <div className="bg-white p-7 rounded-[2rem] shadow-2xl space-y-5 border border-slate-100">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Destinazione</label>
                                <input type="text" list="dl" value={targetDest} onChange={e=>setTargetDest(e.target.value)} className="w-full mt-1 p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700" placeholder="Cerca città..." />
                                <datalist id="dl">{destinations.map(d=><option key={d} value={d}/>)}</datalist>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Modalità</label>
                                    <select value={mode} onChange={e=>setMode(e.target.value)} className="w-full mt-1 p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700">
                                        <option value="">Scegli...</option>
                                        <option value="CONTAINER">Container</option>
                                        <option value="TRUCK">Camion</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Tonnellate</label>
                                    <input type="number" value={tons} onChange={e=>setTons(e.target.value)} className="w-full mt-1 p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700" placeholder="es. 25" />
                                </div>
                            </div>
                            <button onClick={calculate} disabled={calculating} className="w-full bg-blue-600 text-white p-5 rounded-2xl font-black text-sm uppercase tracking-widest shadow-lg shadow-blue-200 active:scale-95 transition-all">
                                {calculating ? "ELABORAZIONE IN CORSO..." : "CALCOLA MIGLIOR PORTO"}
                            </button>
                        </div>

                        {result && (
                            <div className="mt-8 bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl animate-in fade-in slide-in-from-bottom-6 duration-500">
                                <div className="flex justify-between items-start mb-6">
                                    <span className={`px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest ${result.isEst ? 'bg-amber-500' : 'bg-green-500'}`}>
                                        {result.isEst ? "Nuova Destinazione" : "Dato Storico"}
                                    </span>
                                    <div className="text-right">
                                        <p className="text-[10px] text-slate-500 font-bold uppercase">Porto Ottimale</p>
                                        <p className="text-2xl font-black text-blue-400 italic uppercase leading-none mt-1">{result.porto}</p>
                                    </div>
                                </div>
                                
                                <div className="space-y-1 mb-8">
                                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Fornitore</p>
                                    <p className="text-xl font-bold">{result.fwd}</p>
                                    <p className="text-xs text-blue-300 italic font-medium">{Math.round(result.dist)} KM stradali</p>
                                </div>

                                <div className="bg-white/5 p-6 rounded-[1.5rem] border border-white/10">
                                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1 text-center">Costo Totale Stimato</p>
                                    <p className="text-5xl font-black text-center tracking-tighter">€ {(result.unitCost * tons).toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                                    <div className="flex justify-between mt-4 pt-4 border-t border-white/5">
                                        <span className="text-[10px] font-bold text-slate-500 uppercase italic">Tariffa:</span>
                                        <span className="text-[10px] font-black text-blue-400">€ {result.unitCost.toFixed(2)} / TON</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="p-8 text-center">
                        <p className="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em]">Logistics Intelligence System • V2.0</p>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
